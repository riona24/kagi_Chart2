<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ—¥çµŒ225å…ˆç‰© æ‰‹å‹•å…¥åŠ›ã‚«ã‚®è¶³ï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»å®‰å®šç‰ˆï¼‰</title>

<!-- Chart.jsï¼ˆCDNï¼‰ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic Medium",sans-serif;background:linear-gradient(135deg,#1e3c72,#2a5298);min-height:100vh;padding:20px}
.container{max-width:1200px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.12);overflow:hidden}
.header{background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;padding:22px;text-align:center}
.header h1{font-weight:500;font-size:20px}
.main{display:grid;grid-template-columns:360px 1fr}
@media(max-width:980px){.main{grid-template-columns:1fr}}
.left{background:#f8f9fa;border-right:1px solid #e9ecef;padding:16px}
.right{padding:16px}
h2{font-size:14px;color:#34495e;margin:18px 0 10px}
.card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px;margin-bottom:12px}
label{display:block;font-size:12px;color:#2c3e50;margin-bottom:6px}
input,select,button{font:inherit}
.input{width:100%;padding:10px;border:2px solid #e1e8ed;border-radius:8px}
.input:focus{outline:none;border-color:#3498db;box-shadow:0 0 0 3px rgba(52,152,219,.1)}
.row{display:flex;gap:8px;align-items:end}
.btn{padding:10px 14px;border:none;border-radius:8px;color:#fff;cursor:pointer}
.btn-primary{background:#2980b9}.btn-green{background:#27ae60}.btn-red{background:#e74c3c}.btn-gray{background:#7f8c8d}.btn-amber{background:#f39c12}
.small{padding:8px 10px;font-size:12px}
.list{max-height:160px;overflow:auto;border:1px solid #e9ecef;border-radius:8px;background:#fff}
.item{display:flex;justify-content:space-between;gap:8px;padding:8px 10px;border-bottom:1px solid #f2f2f2}
.item:last-child{border-bottom:none}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.kpi .box{background:#fff;border-left:4px solid #3498db;border-radius:10px;text-align:center;padding:10px;box-shadow:0 1px 6px rgba(0,0,0,.06)}
.kpi .v{font-weight:700;color:#2c3e50}
.kpi .l{font-size:12px;color:#7f8c8d}
.log{background:#2c3e50;color:#ecf0f1;border-radius:8px;padding:10px;font:12px/1.6 ui-monospace,Consolas,monospace;max-height:140px;overflow:auto}
.up{color:#27ae60}.down{color:#e74c3c}
.toolbar{display:flex;gap:8px;align-items:center;background:#f8f9fa;border:1px solid #e9ecef;border-radius:8px;padding:8px;margin-bottom:10px}
.range{flex:1}
.info{font-size:12px;color:#7f8c8d}
</style>
</head>
<body>
<div class="container">
  <div class="header"><h1>ğŸ“ˆ æ—¥çµŒ225å…ˆç‰© æ‰‹å‹•å…¥åŠ›ã‚«ã‚®è¶³ï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»å®‰å®šç‰ˆï¼‰</h1></div>
  <div class="main">

    <!-- å·¦ãƒ‘ãƒãƒ« -->
    <div class="left">
      <div class="card">
        <h2>ä¾¡æ ¼å…¥åŠ›</h2>
        <label>ç¾åœ¨ä¾¡æ ¼ (å††)</label>
        <div class="row">
          <input id="priceInput" type="number" class="input" placeholder="ä¾‹: 33500" inputmode="numeric" />
          <button id="addPriceBtn" class="btn btn-green small">è¿½åŠ </button>
        </div>
        <label style="margin-top:8px">æ—¥æ™‚ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
        <input id="datetimeInput" type="datetime-local" class="input" />
      </div>

      <div class="card">
        <h2>ã‚«ã‚®è¶³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼</h2>
        <label>è»¢æ›ç‡ (%)</label>
        <input id="reversalPercent" type="number" class="input" value="0.1" step="0.01" min="0.01" />
        <div style="margin-top:8px"><button id="recalculateBtn" class="btn btn-amber small">ğŸ”„ å†è¨ˆç®—</button></div>
      </div>

      <div class="card">
        <h2>å£²è²·è¨˜éŒ²</h2>
        <label>å–å¼•ã‚¿ã‚¤ãƒ—</label>
        <select id="tradeType" class="input">
          <option value="buy">è²·ã„ (BUY)</option>
          <option value="sell">å£²ã‚Š (SELL)</option>
        </select>
        <div class="row" style="margin-top:8px;flex-wrap:wrap">
          <button id="addTradeBtn" class="btn btn-primary small">âœ… ãƒãƒ¼ã‚¯</button>
          <button id="deleteSelectedTradeBtn" class="btn btn-red small">ğŸ—‘ é¸æŠãƒãƒ¼ã‚¯å‰Šé™¤</button>
          <button id="clearTradesBtn" class="btn btn-gray small">ğŸ§¹ å…¨ãƒãƒ¼ã‚¯å‰Šé™¤</button>
        </div>
        <div id="tradeLog" class="info" style="margin-top:6px">â€”</div>
        <div id="plTotal" style="margin-top:4px;font-weight:700"></div>
        <div class="list" id="tradeList" style="margin-top:8px"><div class="item" style="justify-content:center;color:#7f8c8d">ãƒãƒ¼ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>
      </div>

      <div class="card">
        <h2>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
        <div class="row" style="flex-wrap:wrap">
          <button id="downloadBtn" class="btn btn-gray small">ğŸ’¾ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          <button id="sampleBtn" class="btn btn-primary small">ğŸ“Š ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿</button>
          <button id="clearBtn" class="btn btn-red small">ğŸ—‘ï¸ å…¨ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="row" style="flex-wrap:wrap;margin-top:6px">
          <button id="saveBtn" class="btn btn-green small">ğŸ“ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</button>
          <button id="restoreBtn" class="btn btn-gray small">â†©ï¸ ä¿å­˜ã‹ã‚‰å¾©å…ƒ</button>
          <label class="info" style="display:flex;gap:6px;align-items:center">
            <input type="checkbox" id="autosaveToggle" checked>è‡ªå‹•ä¿å­˜
          </label>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“¦ JSON / CSV å…¥å‡ºåŠ›</h2>
        <div class="row" style="flex-wrap:wrap">
          <button id="exportJsonBtn" class="btn btn-gray small">ğŸ§¾ JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <button id="importJsonBtn" class="btn btn-primary small">ğŸ“¥ JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
          <button id="importCsvBtn" class="btn btn-primary small">ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <input id="importCsvFile" type="file" accept=".csv,text/csv" style="display:none">
        </div>
        <div class="info" style="margin-top:6px">å½“ã‚¢ãƒ—ãƒªå½¢å¼ï¼ˆtimestamp,datetime,priceï¼‰ã‚„ä¸€èˆ¬çš„ãª (date/datetime,price) ã‚‚èª­ã‚ã¾ã™ã€‚</div>
      </div>

      <div class="kpi">
        <div class="box"><div class="v" id="lastUpdate">æœªå…¥åŠ›</div><div class="l">æœ€çµ‚å…¥åŠ›</div></div>
        <div class="box"><div class="v" id="dataCount">0</div><div class="l">ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿æ•°</div></div>
        <div class="box"><div class="v" id="currentPrice">---</div><div class="l">æœ€æ–°ä¾¡æ ¼</div></div>
        <div class="box"><div class="v" id="kagiCount">0</div><div class="l">ã‚«ã‚®ç·šæ•°</div></div>
      </div>

      <div class="card">
        <h2>å…¥åŠ›å±¥æ­´</h2>
        <div class="list" id="priceList"><div class="item" style="justify-content:center;color:#7f8c8d">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div></div>
      </div>

      <div class="card info">ğŸ“Œ è»¢æ›ç‡ 0.1% ã¯ç´„ 40 å††å¹… / ã‚µãƒ³ãƒ—ãƒ«ã§å‹•ä½œç¢ºèªã§ãã¾ã™</div>
    </div>

    <!-- å³ãƒ‘ãƒãƒ« -->
    <div class="right">
      <div class="toolbar">
        <span class="info">è¡¨ç¤ºç¯„å›²</span>
        <input id="chartRange" class="range" type="range" min="0" max="100" value="100" step="1">
        <span id="rangeInfo" class="info">å…¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</span>
        <button id="zoomOutBtn" class="btn btn-gray small">âˆ’</button>
        <button id="zoomInBtn"  class="btn btn-gray small">ï¼‹</button>
        <button id="latestBtn"  class="btn btn-gray small">æœ€æ–°</button>
      </div>
      <div style="background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:10px">
        <canvas id="kagiChart" height="380"></canvas>
      </div>
      <div class="log" id="dataLog" style="margin-top:10px"><div>ã‚·ã‚¹ãƒ†ãƒ èµ·å‹• - æ—¥çµŒ225å…ˆç‰©æ‰‹å‹•å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹</div></div>
    </div>
  </div>
</div>

<script>
/* ==== å®‰å®šåŒ–ãƒã‚¤ãƒ³ãƒˆï¼šã™ã¹ã¦ getElementById ã§å‚ç…§ ==== */
const el = {};
function $(id){ return document.getElementById(id); }

/* å…±æœ‰å¤‰æ•° */
let chart=null, priceData=[], kagiData=[], trades=[];
let selectedIdx=null, selectedTradeIdx=null;
let viewStart=0, viewEnd=0, maxViewWidth=20;
const COLOR={buy:'#2ecc71', sell:'#e74c3c', pair:'#7f8c8d55'};
const SHAPE={buy:'triangle', sell:'rectRot'};
const STORAGE_KEY='kagi_manual_storage_v1';

/* ãƒ­ã‚° */
function log(msg){
  const box = el.dataLog;
  const line = document.createElement('div');
  line.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
  box.appendChild(line);
  box.scrollTop = box.scrollHeight;
  if(box.children.length>120) box.children[0].remove();
}

/* çŠ¶æ…‹IO */
function getStateObject(){ return { priceData, trades, reversalPercent:+el.reversalPercent.value, maxViewWidth }; }
function applyStateObject(s){
  if(!s) return;
  priceData=Array.isArray(s.priceData)?s.priceData:[];
  trades=Array.isArray(s.trades)?s.trades:[];
  if(typeof s.reversalPercent==='number') el.reversalPercent.value=s.reversalPercent;
  if(typeof s.maxViewWidth==='number') maxViewWidth=s.maxViewWidth;
  selectedIdx=null; selectedTradeIdx=null;
  drawChart(); updateLists(); maybeAutoSave();
}
function saveState(manual=false){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({savedAt:Date.now(), ...getStateObject()})); if(manual) log('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã—ã¾ã—ãŸ'); }
  catch{ alert('ä¿å­˜å¤±æ•—'); }
}
function restoreState(){
  try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return alert('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); applyStateObject(JSON.parse(raw)); log('ä¿å­˜ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ'); }
  catch{ alert('å¾©å…ƒå¤±æ•—'); }
}
function maybeAutoSave(){ if(el.autosaveToggle.checked) saveState(false); }

/* ã‚«ã‚®è¶³ */
function calcKagi(list,rev){
  if(!list.length) return [];
  const k=[],f=list[0];let last=f.price,trend=1;
  k.push({x:0,y:last,trend,timestamp:f.timestamp});
  for(let i=1;i<list.length;i++){
    const p=list[i].price,diff=p-last,chg=Math.abs(diff/last)*100;
    if(chg<rev) continue;
    const nt=diff>0?1:-1;
    if(nt!==trend){trend=nt;last=p;k.push({x:k.length,y:p,trend,timestamp:list[i].timestamp});}
    else if((trend===1&&p>last)||(trend===-1&&p<last)){last=p;k.push({x:k.length,y:p,trend,timestamp:list[i].timestamp});}
  }
  return k;
}
function toPath(d){
  if(d.length<2) return d;
  const r=[];let x=0;r.push({...d[0],x});
  for(let i=1;i<d.length;i++){
    if(d[i].trend!==d[i-1].trend){x++;r.push({x,y:d[i-1].y,isHorizontal:true,timestamp:d[i].timestamp});}
    r.push({x,y:d[i].y,trend:d[i].trend,isVertical:true,timestamp:d[i].timestamp});
  }
  return r;
}

/* Chart */
function initChart(){
  const ctx=el.kagiChart.getContext('2d');
  chart=new Chart(ctx,{type:'line',data:{datasets:[
    {label:'kagi',data:[],borderWidth:4,borderColor:'#3498db',backgroundColor:'transparent',pointBorderColor:'#2c3e50',pointBorderWidth:2,tension:0},
    {type:'scatter',label:'trade',data:[],showLine:false,pointRadius:12,pointBorderWidth:3},
    {type:'line',label:'pair',data:[],showLine:true,fill:false,borderDash:[6,4],borderColor:COLOR.pair,pointRadius:0},
    {type:'scatter',label:'selected',data:[],showLine:false,pointRadius:12,pointStyle:'circle',pointBackgroundColor:'#f1c40f',pointBorderColor:'#2c3e50',pointBorderWidth:3},
    {type:'scatter',label:'tradeSelected',data:[],showLine:false,pointRadius:14,pointStyle:'circle',pointBackgroundColor:'#f1c40f',pointBorderColor:'#2c3e50',pointBorderWidth:4}
  ]},options:{responsive:true,interaction:{intersect:false,mode:'nearest'},plugins:{legend:{display:false}},
    scales:{x:{type:'linear',min:0,max:maxViewWidth},y:{ticks:{callback:v=>'Â¥'+Math.round(v).toLocaleString()}}}} );
  chart.canvas.addEventListener('click', onChartClick);
}
function drawChart(){
  kagiData=toPath( calcKagi(priceData,+el.reversalPercent.value) );
  chart.data.datasets[0].data=kagiData.map(p=>({x:p.x,y:p.y}));
  chart.data.datasets[0].data.forEach((d,i)=>{ d.radius=kagiData[i].isHorizontal?7:10; d.hitRadius=15; d.hoverRadius=d.radius+3;
    d.backgroundColor=kagiData[i].isHorizontal?'#95a5a6':(kagiData[i].trend===1?COLOR.buy:COLOR.sell); d.borderWidth=2; d.borderColor='#2c3e50'; });
  chart.data.datasets[1].data=trades.map(t=>({x:t.x,y:t.y}));
  chart.data.datasets[1].pointBackgroundColor=trades.map(t=>COLOR[t.type]);
  chart.data.datasets[1].pointStyle=trades.map(t=>SHAPE[t.type]);
  chart.data.datasets[1].pointBorderColor='#2c3e50'; chart.data.datasets[1].pointRadius=12; chart.data.datasets[1].pointBorderWidth=3;
  chart.data.datasets[4].data=(selectedTradeIdx!==null && trades[selectedTradeIdx])?[{x:trades[selectedTradeIdx].x,y:trades[selectedTradeIdx].y}]:[];
  updatePairLines(); updateViewRange(); highlightSelected(false); chart.update('active');
  updateTradeLog(); updateKPI(); updateLists();
}
function updatePairLines(){
  const seg=[];let open=null;
  trades.forEach(t=>{ if(!open){open=t;return;} if(open.type!==t.type){ seg.push({x:open.x,y:open.y},{x:t.x,y:t.y},{x:NaN,y:NaN}); open=null; } else { open=t; }});
  chart.data.datasets[2].data=seg;
}
function updateViewRange(){
  if(!kagiData.length) return;
  const totalWidth=Math.max(...kagiData.map(p=>p.x))+1;
  const val=+el.chartRange.value;
  const width=Math.min(maxViewWidth,totalWidth);
  if(val===100){ viewEnd=totalWidth; viewStart=Math.max(0,viewEnd-width); }
  else{ const maxStart=Math.max(0,totalWidth-width); viewStart=Math.floor((val/100)*maxStart); viewEnd=Math.min(viewStart+width,totalWidth); }
  chart.options.scales.x.min=viewStart; chart.options.scales.x.max=viewEnd;
  if(totalWidth<=maxViewWidth){ el.rangeInfo.textContent='å…¨ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º'; el.chartRange.disabled=true; }
  else{ el.rangeInfo.textContent=`${viewStart+1}-${viewEnd}/${totalWidth}`; el.chartRange.disabled=false; }
}
function highlightSelected(update=true){
  const ds=chart.data.datasets[3];
  ds.data = selectedIdx!==null ? [{x:kagiData[selectedIdx].x,y:kagiData[selectedIdx].y}] : [];
  if(update) chart.update('active');
}
function onChartClick(evt){
  const els=chart.getElementsAtEventForMode(evt,'nearest',{intersect:false,axis:'xy'},true);
  if(!els.length) return;
  const elx=els[0];
  if(elx.datasetIndex===0){ selectedIdx=elx.index; highlightSelected(); }
  else if(elx.datasetIndex===1){ selectedTradeIdx=elx.index; drawChart(); }
}

/* è¡¨ç¤ºãƒ»ãƒªã‚¹ãƒˆ */
function updateTradeLog(){
  const box=el.tradeLog;
  if(!trades.length){ box.textContent='â€”'; el.plTotal.textContent=''; return; }
  let html='',pl=0,open=null;
  trades.forEach((t,i)=>{ html+=`${i+1}. ${t.type.toUpperCase()} Â¥${t.y.toLocaleString()} ${new Date(t.timestamp).toLocaleTimeString()}ã€€`; 
    if(!open){open=t;} else if(open.type!==t.type){ pl+= open.type==='buy'? t.y-open.y : open.y-t.y; open=null; } else { open=t; }});
  box.innerHTML=html;
  el.plTotal.innerHTML=`ç´¯è¨ˆæç›Š: <span style="color:${pl>=0?'#27ae60':'#e74c3c'}">${pl>=0?'+':''}${pl.toLocaleString()}</span>`;
}
function updateKPI(){
  el.dataCount.textContent=priceData.length;
  el.kagiCount.textContent=kagiData.length;
  if(priceData.length){ const l=priceData[priceData.length-1];
    el.currentPrice.textContent='Â¥'+l.price.toLocaleString();
    el.lastUpdate.textContent=new Date(l.timestamp).toLocaleTimeString();
  }else{ el.currentPrice.textContent='---'; el.lastUpdate.textContent='æœªå…¥åŠ›'; }
}
function updateLists(){ updatePriceList(); updateTradeList(); }
function updatePriceList(){
  const box=el.priceList; box.innerHTML='';
  if(!priceData.length){ box.innerHTML='<div class="item" style="justify-content:center;color:#7f8c8d">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  priceData.forEach((d,i)=>{ const li=document.createElement('div'); li.className='item';
    li.innerHTML=`<div><b>#${i+1}</b> Â¥${d.price.toLocaleString()}<br><span class="info">${new Date(d.timestamp).toLocaleString()}</span></div>
                  <button class="btn btn-red small" data-idx="${i}">å‰Šé™¤</button>`;
    box.appendChild(li);
  });
}
function updateTradeList(){
  const box=el.tradeList; box.innerHTML='';
  if(!trades.length){ box.innerHTML='<div class="item" style="justify-content:center;color:#7f8c8d">ãƒãƒ¼ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  trades.forEach((t,i)=>{ const li=document.createElement('div'); li.className='item';
    const active = i===selectedTradeIdx ? 'style="text-decoration:underline;font-weight:700"' : '';
    li.innerHTML=`<div ${active}><b>#${i+1}</b> ${t.type.toUpperCase()} Â¥${t.y.toLocaleString()}<br><span class="info">${new Date(t.timestamp).toLocaleString()}</span></div>
                  <button class="btn btn-red small" data-tidx="${i}">å‰Šé™¤</button>`;
    box.appendChild(li);
  });
}

/* æ“ä½œ */
function addPrice(){
  const v=el.priceInput.value.trim(); if(!v) return alert('ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const p=Math.round(+v); if(!isFinite(p)||p<=0) return alert('æ­£ã—ã„ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  const ts=el.datetimeInput.value ? new Date(el.datetimeInput.value).getTime() : Date.now();
  priceData.push({timestamp:ts,price:p});
  log(`ä¾¡æ ¼è¿½åŠ : Â¥${p.toLocaleString()}`);
  selectedIdx=null; drawChart(); rebindTrades(); updateLists(); maybeAutoSave(); el.priceInput.value='';
}
function rebindTrades(){
  if(!kagiData.length || !trades.length) return;
  trades.forEach(t=>{
    let best=0,bd=1e18;
    for(let i=0;i<kagiData.length;i++){
      const dx=kagiData[i].x-t.x, dy=kagiData[i].y-t.y, d=dx*dx+dy*dy;
      if(d<bd){bd=d;best=i;}
    }
    t.x=kagiData[best].x; t.y=kagiData[best].y;
  });
}
function markSelected(){
  if(selectedIdx===null) return alert('ã¾ãšãƒãƒ£ãƒ¼ãƒˆä¸Šã®ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯');
  const type=el.tradeType.value; const p=kagiData[selectedIdx];
  trades.push({x:p.x,y:p.y,type,timestamp:Date.now()}); selectedTradeIdx=trades.length-1;
  log(`${type==='buy'?'è²·ã„':'å£²ã‚Š'}ãƒãƒ¼ã‚¯: Â¥${p.y.toLocaleString()}`); selectedIdx=null; drawChart(); updateTradeList(); maybeAutoSave();
}
function deleteSelectedTrade(){
  if(selectedTradeIdx===null) return alert('å‰Šé™¤ã™ã‚‹ãƒãƒ¼ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆãƒãƒ£ãƒ¼ãƒˆã®ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰');
  const r=trades.splice(selectedTradeIdx,1)[0]; log(`é¸æŠãƒãƒ¼ã‚¯å‰Šé™¤: ${r.type}`); selectedTradeIdx=null; drawChart(); updateTradeList(); maybeAutoSave();
}
function clearTrades(){ if(!trades.length) return; if(!confirm('å…¨ã¦ã®å£²è²·ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; trades=[]; selectedTradeIdx=null; drawChart(); updateTradeList(); maybeAutoSave(); }
function clearAll(){
  if(!priceData.length && !trades.length) return;
  if(!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  priceData=[]; trades=[]; kagiData=[]; selectedIdx=null; selectedTradeIdx=null; drawChart(); updateLists(); log('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢'); maybeAutoSave();
}
function downloadCSV(){
  if(!priceData.length) return alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
  const csv='timestamp,datetime,price\n'+priceData.map(d=>`${d.timestamp},${new Date(d.timestamp).toLocaleString()},${d.price}`).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='kagi_'+new Date().toISOString().slice(0,10)+'.csv'; a.click(); URL.revokeObjectURL(a.href);
}
function exportJSON(){
  const blob=new Blob([JSON.stringify(getStateObject())],{type:'application/json'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='kagi_state_'+new Date().toISOString().slice(0,10)+'.json'; a.click(); URL.revokeObjectURL(a.href);
}
function importJSONFile(f){
  const r=new FileReader(); r.onload=()=>{ try{ applyStateObject(JSON.parse(r.result)); log('JSONã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ'); }catch{ alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—'); } }; r.readAsText(f);
}

/* CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ */
function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(l=>l.trim()!==''); if(!lines.length) return [];
  const head=lines[0].split(/,|\t/).map(s=>s.trim());
  const hasHeader=head.some(h=>/timestamp|datetime|date|time|price|close|çµ‚å€¤|ä¾¡æ ¼/i.test(h));
  const rows=hasHeader?lines.slice(1):lines;
  let idx={timestamp:-1, datetime:-1, price:-1};
  if(hasHeader){
    head.forEach((h,i)=>{const L=h.toLowerCase();
      if(L.includes('timestamp')) idx.timestamp=i;
      else if(/(datetime|date|time|æ—¥æ™‚|æ—¥ä»˜)/i.test(h)) idx.datetime=i;
      else if(/(price|close|çµ‚å€¤|ä¾¡æ ¼)/i.test(h)) idx.price=i;
    });
  }
  const out=[]; const base=Date.now()-rows.length*60000;
  rows.forEach((line,i)=>{ const c=line.split(/,|\t/);
    let price=null;
    if(idx.price>=0) price=Number(c[idx.price]);
    if(price===null || Number.isNaN(price)) price=Number(c.find(x=>/^[+-]?\d+(\.\d+)?$/.test(x?.trim())));
    if(Number.isNaN(price)) return;
    price=Math.round(price);
    let ts=null;
    if(idx.timestamp>=0){ const t=Number(c[idx.timestamp]); if(!Number.isNaN(t)&&t>1e11) ts=t; }
    if(!ts && idx.datetime>=0){ const d=new Date(c[idx.datetime]); if(!Number.isNaN(d.getTime())) ts=d.getTime(); }
    if(!ts) ts=base+i*60000;
    out.push({timestamp:ts,price});
  });
  return out;
}
function importCSVText(text){
  const arr=parseCSV(text);
  if(!arr.length) return alert('CSVã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸ');
  priceData=arr; trades=[]; selectedIdx=null; selectedTradeIdx=null;
  log(`CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ: ${arr.length}ä»¶`); drawChart(); updateLists(); maybeAutoSave();
}
function importCSVFile(f){ const r=new FileReader(); r.onload=()=>importCSVText(r.result); r.readAsText(f); }

/* ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼†åˆæœŸåŒ– */
window.addEventListener('DOMContentLoaded', () => {
  // DOMã‚­ãƒ£ãƒƒã‚·ãƒ¥
  ['priceInput','datetimeInput','reversalPercent','tradeType','addPriceBtn','addTradeBtn','deleteSelectedTradeBtn','clearTradesBtn','recalculateBtn','sampleBtn','clearBtn','downloadBtn','saveBtn','restoreBtn','exportJsonBtn','importJsonBtn','importFile','importCsvBtn','importCsvFile','autosaveToggle','priceList','tradeList','kagiChart','chartRange','rangeInfo','dataLog','tradeLog','plTotal','dataCount','kagiCount','currentPrice','lastUpdate'].forEach(id=>el[id]=$id(id));
  function $id(id){ return document.getElementById(id); }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  el.addPriceBtn.onclick=addPrice;
  el.priceInput.addEventListener('keypress',e=>{if(e.key==='Enter')addPrice();});
  el.addTradeBtn.onclick=markSelected;
  el.deleteSelectedTradeBtn.onclick=deleteSelectedTrade;
  el.clearTradesBtn.onclick=clearTrades;
  el.recalculateBtn.onclick=()=>{ if(priceData.length){ drawChart(); rebindTrades(); drawChart(); } };
  el.reversalPercent.onchange=()=>{ if(priceData.length){ drawChart(); rebindTrades(); drawChart(); } maybeAutoSave(); };
  el.sampleBtn.onclick=()=>{
    priceData=[]; trades=[]; selectedIdx=null; selectedTradeIdx=null;
    const p=[40000,40500,39500,40500,40000,41000,39000,42000,38000,43000,37000,44000,36000,45000,35000,46000,34000,47000,33000,48000,32000,47500,33500,46000,35000,44500,36500,43000,38000,41500];
    const base=Date.now()-p.length*60000; p.forEach((v,i)=>priceData.push({timestamp:base+i*60000,price:v}));
    drawChart(); updateLists(); log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¿½åŠ '); maybeAutoSave();
  };
  el.clearBtn.onclick=clearAll;
  el.downloadBtn.onclick=downloadCSV;
  el.saveBtn.onclick=()=>saveState(true);
  el.restoreBtn.onclick=restoreState;
  el.exportJsonBtn.onclick=exportJSON;
  el.importJsonBtn.onclick=()=>el.importFile.click();
  el.importFile.addEventListener('change',e=>{const f=e.target.files?.[0]; if(f) importJSONFile(f);});
  el.importCsvBtn.onclick=()=>el.importCsvFile.click();
  el.importCsvFile.addEventListener('change',e=>{const f=e.target.files?.[0]; if(f) importCSVFile(f);});
  el.priceList.addEventListener('click',e=>{
    const btn=e.target.closest('button[data-idx]'); if(!btn) return;
    const i=+btn.dataset.idx; const r=priceData.splice(i,1)[0]; log(`å…¥åŠ›å‰Šé™¤: Â¥${r.price.toLocaleString()}`); drawChart(); rebindTrades(); updateLists(); maybeAutoSave();
  });
  el.tradeList.addEventListener('click',e=>{
    const btn=e.target.closest('button[data-tidx]'); if(!btn) return;
    const i=+btn.dataset.tidx; const r=trades.splice(i,1)[0]; log(`ãƒãƒ¼ã‚¯å‰Šé™¤: ${r.type}`); if(selectedTradeIdx===i) selectedTradeIdx=null; else if(selectedTradeIdx>i) selectedTradeIdx--;
    drawChart(); updateTradeList(); maybeAutoSave();
  });
  el.chartRange.addEventListener('input',()=>{updateViewRange(); chart.update('active');});
  document.getElementById('zoomOutBtn').onclick=()=>{maxViewWidth=Math.min(maxViewWidth+5,50);updateViewRange();chart.update('active');maybeAutoSave();};
  document.getElementById('zoomInBtn').onclick=()=>{maxViewWidth=Math.max(maxViewWidth-5,5);updateViewRange();chart.update('active');maybeAutoSave();};
  document.getElementById('latestBtn').onclick=()=>{el.chartRange.value=100;updateViewRange();chart.update('active');maybeAutoSave();};

  // åˆæœŸå€¤
  const now=new Date(); now.setMinutes(now.getMinutes()-now.getTimezoneOffset()); el.datetimeInput.value=now.toISOString().slice(0,16);

  // ãƒãƒ£ãƒ¼ãƒˆ
  initChart();

  // æ—¢å­˜ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãŒã‚ã‚Œã°å¾©å…ƒ
  try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw){ applyStateObject(JSON.parse(raw)); log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ'); } }catch{}

  log('åˆæœŸåŒ–å®Œäº†');
});

/* ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒ­ã‚° -> ç”»é¢ä¸‹ã«è¡¨ç¤º */
window.addEventListener('error',(e)=>{try{el.dataLog && log('âš ï¸ ã‚¨ãƒ©ãƒ¼: '+(e?.message||e.type));}catch{}});
window.addEventListener('unhandledrejection',(e)=>{try{el.dataLog && log('âš ï¸ Promise: '+(e?.reason?.message||String(e.reason)));}catch{}});
</script>
</body>
</html>
